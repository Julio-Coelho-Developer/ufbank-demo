name: UFBank CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  DOCKER_IMAGE: ufbank-app
  DOCKER_TAG: latest

jobs:
  # ============================================
  # Job 1: Build and Test
  # ============================================
  build-and-test:
    name: Build & Test Application
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ğŸ” Lint Dockerfile
        run: |
          docker run --rm -i hadolint/hadolint < app/Dockerfile || true
      
      - name: ğŸ—ï¸ Build Docker Image
        run: |
          cd app
          docker build -t ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }} .
          docker tag ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }} ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
      
      - name: ğŸ” Scan Image for Vulnerabilities
        run: |
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy:latest image --severity HIGH,CRITICAL \
            ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }} || true
      
      - name: âœ… Test Container
        run: |
          docker run -d --name test-container -p 8888:80 ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}
          sleep 5
          curl -f http://localhost:8888 || exit 1
          docker stop test-container
          docker rm test-container
      
      - name: ğŸ’¾ Save Docker Image
        run: |
          docker save ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }} > ufbank-app.tar
      
      - name: ğŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: ufbank-app.tar
          retention-days: 1

  # ============================================
  # Job 2: Terraform Validation
  # ============================================
  terraform-validate:
    name: Validate Terraform
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
      
      - name: ğŸ¨ Terraform Format Check
        run: |
          cd terraform
          terraform fmt -check -recursive
        continue-on-error: true
      
      - name: âš™ï¸ Terraform Init
        run: |
          cd terraform
          terraform init
      
      - name: âœ… Terraform Validate
        run: |
          cd terraform
          terraform validate
      
      - name: ğŸ“‹ Terraform Plan
        run: |
          cd terraform
          terraform plan -out=tfplan
        continue-on-error: true

  # ============================================
  # Job 3: Security Scan
  # ============================================
  security-scan:
    name: Security Analysis
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”’ Run Checkov Security Scan
        run: |
          pip install checkov
          checkov -d terraform/ --framework terraform || true
      
      - name: ğŸ” Check for Secrets
        run: |
          docker run --rm -v $(pwd):/src trufflesecurity/trufflehog:latest \
            filesystem /src --only-verified || true

  # ============================================
  # Job 4: Deploy to Development
  # ============================================
  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: [build-and-test, terraform-validate]
    if: github.ref == 'refs/heads/develop'
    environment:
      name: development
      url: http://localhost:3000
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ“¥ Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
      
      - name: ğŸ³ Load Docker Image
        run: |
          docker load < ufbank-app.tar
      
      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
      
      - name: ğŸš€ Deploy with Terraform
        run: |
          cd terraform
          terraform init
          terraform apply -auto-approve \
            -var="environment=dev" \
            -var="app_port=3000"
      
      - name: âœ… Verify Deployment
        run: |
          sleep 10
          curl -f http://localhost:3000 || exit 1
      
      - name: ğŸ“Š Show Infrastructure Info
        run: |
          cd terraform
          terraform output

  # ============================================
  # Job 5: Deploy to Staging
  # ============================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-and-test, terraform-validate, security-scan]
    if: github.ref == 'refs/heads/main'
    environment:
      name: staging
      url: http://localhost:4000
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ“¥ Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
      
      - name: ğŸ³ Load Docker Image
        run: |
          docker load < ufbank-app.tar
      
      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
      
      - name: ğŸš€ Deploy with Terraform
        run: |
          cd terraform
          terraform init
          terraform apply -auto-approve \
            -var="environment=staging" \
            -var="app_port=4000"
      
      - name: âœ… Run Integration Tests
        run: |
          sleep 10
          curl -f http://localhost:4000 || exit 1
          echo "Integration tests passed!"
      
      - name: ğŸ“Š Performance Test
        run: |
          echo "Running performance tests..."
          ab -n 100 -c 10 http://localhost:4000/ || true

  # ============================================
  # Job 6: Deploy to Production (Manual Approval)
  # ============================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: http://localhost:5000
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ“¥ Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
      
      - name: ğŸ³ Load Docker Image
        run: |
          docker load < ufbank-app.tar
      
      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
      
      - name: ğŸš€ Blue-Green Deployment
        run: |
          cd terraform
          terraform init
          
          # Deploy new version (Green)
          terraform apply -auto-approve \
            -var="environment=production" \
            -var="app_port=5000"
          
          sleep 10
          
          # Health check
          if curl -f http://localhost:5000; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed! Rolling back..."
            terraform destroy -auto-approve
            exit 1
          fi
      
      - name: ğŸ“Š Post-Deployment Validation
        run: |
          echo "Running smoke tests..."
          curl -f http://localhost:5000 || exit 1
          echo "âœ… All smoke tests passed!"
      
      - name: ğŸ‰ Deployment Summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸš€ UFBank Deployed to Production!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Environment: Production"
          echo "Version: ${{ github.sha }}"
          echo "Deployed by: ${{ github.actor }}"
          echo "URL: http://localhost:5000"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # ============================================
  # Job 7: Notification
  # ============================================
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: always()
    
    steps:
      - name: ğŸ“§ Send Success Notification
        if: needs.deploy-production.result == 'success'
        run: |
          echo "âœ… Deployment successful! All systems operational."
      
      - name: ğŸ“§ Send Failure Notification
        if: needs.deploy-production.result == 'failure'
        run: |
          echo "âŒ Deployment failed! Please check logs."
