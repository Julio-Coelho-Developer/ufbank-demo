name: UFBank CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # ============================================
  # Job 1: Build e Test da Aplica√ß√£o
  # ============================================
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
      
      - name: üê≥ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: üèóÔ∏è Build Docker Image
        run: |
          cd app
          docker build -t ufbank-app:${{ github.sha }} .
          docker tag ufbank-app:${{ github.sha }} ufbank-app:latest
          echo "‚úì Build conclu√≠do!"
      
      - name: ‚úÖ Test Container
        run: |
          docker run -d --name test-app -p 8888:80 ufbank-app:latest
          sleep 10
          
          # Testar se responde
          curl -f http://localhost:8888 || exit 1
          
          # Testar arquivos est√°ticos
          curl -f http://localhost:8888/style.css || exit 1
          curl -f http://localhost:8888/script.js || exit 1
          
          # Limpar
          docker stop test-app
          docker rm test-app
          
          echo "‚úì Todos os testes passaram!"
      
      - name: üìä Build Summary
        run: |
          echo "### ‚úì Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Autor:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Job 2: An√°lise de Seguran√ßa
  # ============================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
      
      - name: üîí Scan de Vulnerabilidades
        run: |
          echo "Executando scan de seguran√ßa..."
          
          # Verificar secrets vazados
          if grep -r "password\|secret\|api_key" --include="*.js" --include="*.yml" .; then
            echo "‚ö†Ô∏è Poss√≠veis secrets encontrados!"
          else
            echo "‚úì Nenhum secret detectado"
          fi
          
          echo "‚úì Security scan conclu√≠do!"

  # ============================================
  # Job 3: Deploy Simulado
  # ============================================
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [build-and-test, security]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
      
      - name: üöÄ Deploy Simulation
        run: |
          echo "========================================="
          echo "üéâ UFBank Deploy Completo!"
          echo "========================================="
          echo ""
          echo "üì¶ Vers√£o: ${{ github.sha }}"
          echo "üåø Branch: ${{ github.ref_name }}"
          echo "üë§ Deploy por: ${{ github.actor }}"
          echo "üìÖ Data: $(date)"
          echo ""
          echo "‚úì Build: OK"
          echo "‚úì Tests: OK"
          echo "‚úì Security: OK"
          echo "‚úì Deploy: OK"
          echo ""
          echo "========================================="
      
      - name: üìä Deploy Summary
        run: |
          echo "### üöÄ Deploy Completo!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ‚úÖ Sucesso |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ‚úÖ Passou |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ‚úÖ OK |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ‚úÖ Completo |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Vers√£o:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Por:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Job 4: Notifica√ß√£o
  # ============================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
      - name: üìß Status do Deploy
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ Pipeline executado com sucesso!"
            echo "üéâ UFBank est√° atualizado!"
          else
            echo "‚ùå Pipeline falhou!"
            echo "Verifique os logs acima."
          fi
